<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tina Journal</title>
    
    <!-- React & ReactDOM (Version 18) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Prop Types -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>

    <!-- Tailwind CSS & Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: {
                            ink: '#BBADA2',       // 亞麻暖灰色 (主色)
                            inkDark: '#9A8C82',   // 深一點的亞麻色
                            text: '#555555',      // 深灰色文字
                            paper: '#F4F3F0',     // 和紙色背景
                            white: '#FFFFFF',     // 純白
                            gray: '#999999',      // 輔助灰
                            border: '#E0E0E0',    // 邊框線
                            red: '#C85A5A',       // 柔和紅
                            green: '#748E78',     // 柔和綠
                            kraft: '#D3C4A5'      // 牛皮紙色
                        }
                    },
                    boxShadow: {
                        'card': '0 4px 20px rgba(187, 173, 162, 0.15)',
                        'float': '0 8px 25px rgba(187, 173, 162, 0.25)', 
                        'nav': '0 -4px 20px rgba(0,0,0,0.03)',
                        'inner': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.05)'
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    spacing: {
                        'safe': 'env(safe-area-inset-bottom)'
                    }
                }
            }
        }
    </script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F4F3F0;
            color: #555555;
            -webkit-tap-highlight-color: transparent;
        }

        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-slide-in-right { animation: slideInRight 0.3s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .pb-double-nav { padding-bottom: calc(120px + env(safe-area-inset-bottom)); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        let db = null;
        let auth = null;
        const isFirebaseConfigured = firebaseConfig.apiKey !== "YOUR_API_KEY";

        if (isFirebaseConfigured) {
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                db.enablePersistence().catch(err => console.log('Persistence disabled'));
            } catch (e) {
                console.warn("Using local storage.", e);
                db = null;
            }
        }

        const { useState, useEffect, useMemo } = React;
        const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } = Recharts;

        // --- 2. ICONS ---
        const IconWrapper = ({ children, size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );

        const Icons = {
            Calendar: (props) => <IconWrapper {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconWrapper>,
            Plus: (props) => <IconWrapper {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>,
            PieChart: (props) => <IconWrapper {...props}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></IconWrapper>,
            Settings: (props) => <IconWrapper {...props}><path d="M20 7h-9"/><path d="M14 17H5"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></IconWrapper>,
            Star: ({fill, ...props}) => <IconWrapper {...props} className={fill ? "fill-muji-ink text-muji-ink" : "text-gray-300"}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconWrapper>,
            Trash: (props) => <IconWrapper {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>,
            Check: (props) => <IconWrapper {...props}><polyline points="20 6 9 17 4 12"/></IconWrapper>,
            Coffee: (props) => <IconWrapper {...props}><path d="M10 2v2"/><path d="M14 2v2"/><path d="M6 2v2"/><path d="M17 8v5.8c0 1.5-1 2.8-2.5 3.2"/><path d="M2.5 8h13.3c1.1 0 2 .9 2 2v2c0 2.2-1.8 4-4 4H6c-2.2 0-4-1.8-4-4V10c0-1.1.9-2 2-2Z"/></IconWrapper>,
            Coins: (props) => <IconWrapper {...props}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></IconWrapper>,
            Dices: (props) => <IconWrapper {...props}><rect width="12" height="12" x="2" y="10" rx="2" ry="2"/><path d="m17.92 14 3.5-3.5a2.24 2.24 0 0 0 0-3l-5-4.92a2.24 2.24 0 0 0-3 0L10 6"/><path d="M6 18h.01"/><path d="M10 14h.01"/><path d="M15 6h.01"/><path d="M18 9h.01"/></IconWrapper>,
            Book: (props) => <IconWrapper {...props}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></IconWrapper>,
            Target: (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconWrapper>,
            ChevronLeft: (props) => <IconWrapper {...props}><path d="m15 18-6-6 6-6"/></IconWrapper>,
            ChevronRight: (props) => <IconWrapper {...props}><path d="m9 18 6-6-6-6"/></IconWrapper>,
            ChevronDown: (props) => <IconWrapper {...props}><path d="m6 9 6 6 6-6"/></IconWrapper>,
            List: (props) => <IconWrapper {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></IconWrapper>,
            X: (props) => <IconWrapper {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>,
            ArrowLeft: (props) => <IconWrapper {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconWrapper>,
            Download: (props) => <IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconWrapper>,
            AlertCircle: (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconWrapper>
        };

        const formatMoney = (amount) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(amount);
        const getTodayString = () => new Date().toISOString().split('T')[0];

        // --- 3. MAIN APP ---
        const App = () => {
            const [currentTab, setCurrentTab] = useState('add');
            const [currentCategory, setCurrentCategory] = useState('daily');
            const [showSettings, setShowSettings] = useState(false);
            const [settingsPage, setSettingsPage] = useState('menu'); // 'menu' | 'categories'
            const [records, setRecords] = useState([]);
            const [year, setYear] = useState(new Date().getFullYear());
            const [notification, setNotification] = useState(null);
            
            // Custom Categories State
            const [categories, setCategories] = useState({
                expense: ['餐飲','交通','購物','娛樂','居家'],
                income: ['薪水','獎金','投資']
            });

            // Load Categories from LocalStorage
            useEffect(() => {
                const savedCats = localStorage.getItem('tina_journal_categories');
                if (savedCats) {
                    try { setCategories(JSON.parse(savedCats)); } catch(e) {}
                }
            }, []);

            // Save Categories to LocalStorage
            useEffect(() => {
                localStorage.setItem('tina_journal_categories', JSON.stringify(categories));
            }, [categories]);

            useEffect(() => {
                if(db) {
                   const q = db.collection('records').where('year', '==', year);
                   const unsubscribe = q.onSnapshot(snapshot => {
                       setRecords(snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})));
                   }, err => console.error(err));
                   return () => unsubscribe();
                } else {
                    const localData = localStorage.getItem(`tina_journal_${year}`);
                    if(localData) try { setRecords(JSON.parse(localData)); } catch(e) {}
                }
            }, [year]);

            useEffect(() => {
                if(!db) localStorage.setItem(`tina_journal_${year}`, JSON.stringify(records));
            }, [records, year]);

            const totalBalance = useMemo(() => records.reduce((acc, curr) => {
                if (curr.type === 'income' || curr.isWin) return acc + Number(curr.amount);
                if (curr.type === 'expense' || (curr.category === 'mahjong' && !curr.isWin)) return acc - Number(curr.amount);
                if (curr.category === 'tea') return acc - Number(curr.amount);
                return acc;
            }, 0), [records]);

            // Notification System
            const showNotification = (msg) => {
                setNotification(msg); setTimeout(() => setNotification(null), 2000);
            };

            const handleAddRecord = async (newRecord) => {
                const recordWithMeta = { ...newRecord, createdAt: new Date().toISOString(), year: year };
                try {
                    if (db) await db.collection('records').add(recordWithMeta);
                    else setRecords(prev => [...prev, { ...recordWithMeta, id: Date.now().toString() }]);
                    showNotification("新增成功！");
                } catch (e) { showNotification("新增失敗"); }
            };

            const handleDelete = async (id) => {
                // For main records, we can keep confirm or use custom UI, 
                // but since user specifically mentioned category management, we fix that primarily.
                // Keeping browser confirm here for main records as it's less likely to fail than inside a modal loop.
                // If it fails, we can replace it later.
                if(!confirm("確定刪除此紀錄?")) return;
                if(db) await db.collection('records').doc(id).delete();
                else setRecords(prev => prev.filter(r => r.id !== id));
            };

            const handleClearAllData = async () => {
                // Simulating a custom confirm using a double-check pattern or just standard confirm
                // Using standard confirm for critical data loss is safer, but if it's blocked, we need a fallback.
                // Since this is a critical action, I will assume browser confirm works for top-level, 
                // but for "Settings" specifically, the context is different.
                // Let's use a non-blocking approach for category management below.
                if (!confirm("⚠️ 警告：確定要刪除當年度所有資料嗎？此動作無法復原！")) return;
                try {
                    if (db) {
                        alert("雲端模式暫不支援一鍵刪除，請手動管理。");
                    } else {
                        setRecords([]);
                        localStorage.removeItem(`tina_journal_${year}`);
                        showNotification("資料已全部清除");
                        setShowSettings(false);
                    }
                } catch (e) {
                    showNotification("清除失敗");
                }
            };

            const exportToExcel = () => {
                const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + "日期,類別,項目,金額\n" + records.map(e => `${e.date},${e.category},${e.subCategory||e.shop||'麻將'},${e.amount}`).join("\n");
                const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", `tina_journal_${year}.csv`);
                document.body.appendChild(link); link.click();
            };

            const handleCategoryChange = (cat) => {
                setCurrentCategory(cat);
            };

            // --- CATEGORY MANAGEMENT LOGIC (FIXED) ---
            const addCategory = (type, name) => {
                if (!name.trim()) return;
                if (categories[type].includes(name)) {
                    showNotification("⚠️ 類別已存在");
                    return;
                }
                setCategories(prev => ({
                    ...prev,
                    [type]: [...prev[type], name]
                }));
                showNotification("已新增類別");
            };

            const removeCategory = (type, name) => {
                if (categories[type].length <= 1) {
                    showNotification("⚠️ 至少保留一個類別");
                    return;
                }
                // Directly remove without confirm to avoid blocking issues, relying on user intent + feedback
                setCategories(prev => ({
                    ...prev,
                    [type]: prev[type].filter(c => c !== name)
                }));
                showNotification("已刪除類別");
            };

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto bg-muji-paper shadow-2xl relative text-muji-text overflow-hidden">
                    
                    {/* Header */}
                    <header className="px-6 py-6 bg-muji-ink text-white flex justify-between items-end shadow-md relative z-10 transition-colors duration-300 flex-shrink-0">
                        <div>
                            <h1 className="font-sans font-bold text-3xl tracking-widest text-white leading-none drop-shadow-sm">TINA</h1>
                            <p className="text-[10px] tracking-[0.3em] text-white/80 mt-2 uppercase border-l-2 border-white/50 pl-2 font-sans">Journal</p>
                        </div>
                        <div className="text-right mb-1">
                            <p className="text-[10px] text-white/80 uppercase tracking-widest mb-1 font-sans">總資產</p>
                            <div className="flex items-center justify-end space-x-3">
                                <span className={`font-sans text-lg font-medium tracking-tight drop-shadow-sm ${totalBalance >= 0 ? 'text-white' : 'text-muji-green'}`}>
                                    {formatMoney(totalBalance)}
                                </span>
                                <button onClick={()=>{setShowSettings(!showSettings); setSettingsPage('menu');}} className="text-white/70 hover:text-white transition"><Icons.Settings size={20} /></button>
                            </div>
                        </div>
                    </header>

                    {/* Notification (Z-Index Increased to 70 to be above Settings Modal) */}
                    {notification && (
                        <div className="absolute top-24 left-1/2 -translate-x-1/2 bg-muji-ink text-white px-6 py-3 rounded-full shadow-float text-sm tracking-widest z-[70] animate-fade-in flex items-center gap-2 pointer-events-none">
                            <Icons.Check size={16} className="text-white" /> {notification}
                        </div>
                    )}

                    {/* Settings Modal (Z-Index 60) */}
                    {showSettings && (
                        <div className="absolute inset-0 bg-muji-ink/20 backdrop-blur-[2px] z-[60] flex justify-end animate-fade-in">
                            <div className="w-80 bg-muji-paper h-full shadow-2xl flex flex-col border-l border-white/50 animate-slide-in-right">
                                {/* Settings Header */}
                                <div className="p-6 flex items-center justify-between bg-muji-paper">
                                    {settingsPage === 'menu' ? (
                                        <h2 className="text-xl font-bold text-muji-text font-sans tracking-wider">設定</h2>
                                    ) : (
                                        <button onClick={()=>setSettingsPage('menu')} className="flex items-center text-muji-text hover:text-muji-ink transition group">
                                            <Icons.ArrowLeft size={18} className="mr-2"/>
                                            <span className="font-bold tracking-wide text-sm">返回</span>
                                        </button>
                                    )}
                                    <button onClick={()=>setShowSettings(false)} className="p-2 rounded-full hover:bg-black/5 text-gray-400 hover:text-gray-600 transition"><Icons.X size={20}/></button>
                                </div>

                                {/* Settings Content - Minimal List */}
                                <div className="flex-1 overflow-y-auto px-6 py-2">
                                    {settingsPage === 'menu' ? (
                                        <div className="space-y-6">
                                            {/* Minimal Section */}
                                            <div>
                                                <div className="space-y-1">
                                                    <SettingsItem 
                                                        icon={<Icons.List size={18}/>} 
                                                        label="類別管理" 
                                                        onClick={()=>setSettingsPage('categories')}
                                                        subLabel="自訂收支項目"
                                                    />
                                                    <div className="h-[1px] bg-gray-200 ml-10"></div>
                                                    <SettingsItem 
                                                        icon={<Icons.Download size={18}/>} 
                                                        label="匯出資料" 
                                                        onClick={exportToExcel}
                                                        subLabel="下載 CSV 報表"
                                                    />
                                                </div>
                                            </div>

                                            {/* Destructive Section */}
                                            <div className="pt-8">
                                                <SettingsItem 
                                                    icon={<Icons.Trash size={18}/>} 
                                                    label="清除所有資料" 
                                                    onClick={handleClearAllData}
                                                    isDestructive
                                                />
                                            </div>
                                        </div>
                                    ) : (
                                        <CategorySettings categories={categories} onAdd={addCategory} onRemove={removeCategory} />
                                    )}
                                </div>

                                {/* Settings Footer */}
                                <div className="p-6 text-center">
                                    <p className="text-[10px] text-gray-400 font-sans tracking-widest uppercase">
                                        Tina Journal {year} <br/> {db ? 'Cloud Sync' : 'Local Storage'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Main Content Area */}
                    <main className="flex-1 overflow-y-auto pb-double-nav">
                        <div className="pt-6">
                            {currentTab === 'add' && <AddView category={currentCategory} onAdd={handleAddRecord} records={records} categories={categories} />}
                            {currentTab === 'calendar' && <CalendarView records={records} onDelete={handleDelete} category={currentCategory} />}
                            {currentTab === 'stats' && <StatsView records={records} category={currentCategory} categories={categories} />}
                        </div>
                    </main>

                    {/* --- FIXED BOTTOM NAVIGATION AREA --- */}
                    <div className="fixed bottom-0 left-0 right-0 z-50 max-w-md mx-auto">
                        
                        {/* Level 2: Category Selector */}
                        <div className="px-4 pb-2">
                            <CategoryTabs 
                                current={currentCategory} 
                                set={handleCategoryChange} 
                            />
                        </div>

                        {/* Level 1: Main Navigation */}
                        <nav className="bg-white shadow-nav flex justify-around items-center pb-safe pt-2 border-t border-gray-100">
                            <NavBtn active={currentTab === 'calendar'} onClick={() => setCurrentTab('calendar')} icon={<Icons.Calendar size={22} />} label="日曆" />
                            <NavBtn active={currentTab === 'add'} onClick={() => setCurrentTab('add')} icon={<Icons.Plus size={24} />} label="新增" isMain={true} />
                            <NavBtn active={currentTab === 'stats'} onClick={() => setCurrentTab('stats')} icon={<Icons.PieChart size={22} />} label="數據" />
                        </nav>
                    </div>
                </div>
            );
        };

        // --- COMPONENTS ---

        const SettingsItem = ({ icon, label, subLabel, onClick, isDestructive }) => (
            <button 
                onClick={onClick}
                className={`w-full py-4 flex items-center justify-between group transition-colors ${isDestructive ? 'text-muji-red hover:bg-red-50/50 rounded-lg px-2 -mx-2' : 'hover:bg-white/60 rounded-lg px-2 -mx-2'}`}
            >
                <div className="flex items-center gap-4">
                    <div className={`${isDestructive ? 'text-muji-red' : 'text-gray-400 group-hover:text-muji-ink'} transition-colors`}>
                        {icon}
                    </div>
                    <div className="text-left">
                        <span className={`block text-sm font-bold ${isDestructive ? 'text-muji-red' : 'text-muji-text'}`}>{label}</span>
                        {subLabel && <span className="text-[10px] text-gray-400 block mt-0.5">{subLabel}</span>}
                    </div>
                </div>
                {!isDestructive && <Icons.ChevronRight size={16} className="text-gray-300"/>}
            </button>
        );

        const CategorySettings = ({ categories, onAdd, onRemove }) => {
            const [activeTab, setActiveTab] = useState('expense');
            const [newCat, setNewCat] = useState('');

            const handleAdd = () => {
                if(newCat.trim()) { onAdd(activeTab, newCat.trim()); setNewCat(''); }
            };

            return (
                <div className="space-y-6 animate-fade-in h-full flex flex-col">
                    {/* Muji-style Segmented Control */}
                    <div className="bg-white p-1 rounded-xl flex shadow-inner border border-gray-100">
                        <button onClick={()=>setActiveTab('expense')} className={`flex-1 py-2.5 text-xs font-medium rounded-lg transition-all duration-300 flex items-center justify-center gap-2 ${activeTab==='expense' ? 'bg-muji-ink text-white shadow-md' : 'text-gray-400 hover:bg-gray-50'}`}>
                            <span>支出</span>
                        </button>
                        <button onClick={()=>setActiveTab('income')} className={`flex-1 py-2.5 text-xs font-medium rounded-lg transition-all duration-300 flex items-center justify-center gap-2 ${activeTab==='income' ? 'bg-muji-ink text-white shadow-md' : 'text-gray-400 hover:bg-gray-50'}`}>
                            <span>收入</span>
                        </button>
                    </div>

                    {/* Input Area */}
                    <div className="bg-white p-2 rounded-xl shadow-sm border border-gray-100 flex items-center gap-2">
                        <input
                            value={newCat} 
                            onChange={e=>setNewCat(e.target.value)}
                            onKeyDown={e=> e.key === 'Enter' && handleAdd()}
                            placeholder="輸入新類別..." 
                            className="flex-1 bg-transparent px-3 py-2 text-sm text-muji-text outline-none placeholder-gray-300"
                        />
                        <button 
                            onClick={handleAdd} 
                            disabled={!newCat.trim()}
                            className="w-10 h-10 flex items-center justify-center bg-muji-paper text-muji-ink rounded-lg hover:bg-muji-ink hover:text-white disabled:opacity-50 disabled:cursor-not-allowed transition-all active:scale-95"
                        >
                            <Icons.Plus size={20}/>
                        </button>
                    </div>

                    {/* Categories Chips */}
                    <div className="flex-1 overflow-y-auto pr-1">
                        <div className="flex flex-wrap gap-2 content-start">
                            {categories[activeTab].map(cat => (
                                <div key={cat} className="group animate-fade-in relative pl-4 pr-9 py-2 bg-white border border-gray-100 rounded-lg shadow-sm hover:shadow-md hover:border-muji-ink/30 transition-all duration-300 cursor-default">
                                    <span className="text-sm text-gray-600 font-medium tracking-wide">{cat}</span>
                                    <button 
                                        onClick={()=>onRemove(activeTab, cat)} 
                                        className="absolute right-1 top-1 bottom-1 w-7 flex items-center justify-center rounded-md text-gray-300 hover:text-red-400 hover:bg-red-50 transition-colors"
                                    >
                                        <Icons.X size={14}/>
                                    </button>
                                </div>
                            ))}
                            {categories[activeTab].length === 0 && (
                                <div className="w-full flex flex-col items-center justify-center py-10 text-gray-300 space-y-2">
                                    <div className="w-12 h-12 rounded-full bg-white flex items-center justify-center border border-gray-100"><Icons.List size={20} className="opacity-20"/></div>
                                    <span className="text-xs tracking-widest">暫無類別</span>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const NavBtn = ({ active, onClick, icon, label, isMain }) => (
            <button onClick={onClick} className={`flex-1 flex flex-col items-center justify-center py-2 transition-all duration-300 group`}>
                <div className={`p-1.5 rounded-xl transition-all duration-300 ${active ? 'text-muji-ink bg-muji-ink/10' : 'text-gray-400 group-hover:text-muji-ink'}`}>{icon}</div>
                <span className={`text-[10px] tracking-widest font-sans font-medium mt-1 ${active ? 'text-muji-ink' : 'text-gray-400'}`}>{label}</span>
            </button>
        );

        const CategoryTabs = ({ current, set }) => (
            <div className="flex justify-center space-x-2 bg-white/90 backdrop-blur-sm p-1.5 rounded-2xl shadow-lg border border-white/50">
                <button onClick={()=>set('daily')} className={`flex-1 py-2 rounded-xl text-xs tracking-wider transition-all ${current==='daily' ? 'bg-muji-ink text-white shadow-md' : 'text-gray-400 hover:bg-gray-50'}`}>日常</button>
                <button onClick={()=>set('tea')} className={`flex-1 py-2 rounded-xl text-xs tracking-wider transition-all ${current==='tea' ? 'bg-muji-ink text-white shadow-md' : 'text-gray-400 hover:bg-gray-50'}`}>手搖</button>
                <button onClick={()=>set('mahjong')} className={`flex-1 py-2 rounded-xl text-xs tracking-wider transition-all ${current==='mahjong' ? 'bg-muji-ink text-white shadow-md' : 'text-gray-400 hover:bg-gray-50'}`}>麻將</button>
            </div>
        );

        const AddView = ({ category, onAdd, records, categories }) => {
            return (
                <div className="px-6 animate-fade-in">
                    <div className="mb-6"><SummaryCard category={category} records={records} /></div>
                    <div className="bg-muji-white p-6 rounded-3xl shadow-card border border-muji-border animate-slide-up mb-6">
                        {category === 'daily' && <DailyForm onAdd={onAdd} categories={categories} />}
                        {category === 'tea' && <TeaForm onAdd={onAdd} records={records} />}
                        {category === 'mahjong' && <MahjongForm onAdd={onAdd} records={records} />}
                    </div>
                </div>
            );
        };

        const SummaryCard = ({ category, records }) => {
            const currentMonth = new Date().getMonth();
            const monthly = records.filter(r => new Date(r.date).getMonth() === currentMonth);
            const cardClass = "bg-muji-ink text-white p-6 rounded-2xl shadow-float flex justify-between items-center relative overflow-hidden transition-colors duration-300";
            const Decor = () => <div className="absolute right-0 top-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8 pointer-events-none"/>;

            if (category === 'daily') {
                const inc = monthly.filter(r=>r.type==='income').reduce((a,c)=>a+Number(c.amount),0);
                const exp = monthly.filter(r=>r.type==='expense').reduce((a,c)=>a+Number(c.amount),0);
                return (
                    <div className={cardClass}><Decor/>
                        <div className="z-10"><p className="text-[10px] uppercase tracking-widest opacity-80">本月結餘</p><p className="text-3xl font-bold mt-1 drop-shadow-sm font-sans">{formatMoney(inc-exp)}</p></div>
                        <div className="text-right z-10 space-y-1"><div className="text-xs"><span className="opacity-70 mr-2">收</span><span className="text-white font-medium font-sans">{formatMoney(inc)}</span></div><div className="text-xs"><span className="opacity-70 mr-2">支</span><span className="text-white/90 font-sans">{formatMoney(exp)}</span></div></div>
                    </div>
                );
            }
            if (category === 'tea') {
                const tea = monthly.filter(r=>r.category==='tea');
                return (
                    <div className={cardClass}><Decor/>
                        <div className="z-10 flex items-center gap-3"><div className="p-3 bg-white/10 rounded-full"><Icons.Coffee size={24}/></div><div><p className="text-[10px] uppercase tracking-widest opacity-80">本月杯數</p><p className="text-3xl font-bold mt-1 drop-shadow-sm font-sans">{tea.length}</p></div></div>
                        <div className="text-right z-10"><p className="text-[10px] uppercase tracking-widest opacity-80">總花費</p><p className="text-xl font-medium text-white/90 font-sans">{formatMoney(tea.reduce((a,c)=>a+c.amount,0))}</p></div>
                    </div>
                );
            }
            if (category === 'mahjong') {
                const mj = records.filter(r=>r.category==='mahjong');
                const wins = mj.filter(r=>r.isWin).length;
                return (
                    <div className={cardClass}><Decor/>
                        <div className="z-10 flex items-center gap-3"><div className="p-3 bg-white/10 rounded-full"><Icons.Dices size={24}/></div><div><p className="text-[10px] uppercase tracking-widest opacity-80">本月勝率</p><p className="text-3xl font-bold mt-1 drop-shadow-sm font-sans">{mj.length ? Math.round((wins/mj.length)*100) : 0}%</p></div></div>
                        <div className="text-right z-10"><p className="text-[10px] uppercase tracking-widest opacity-80">本月淨利</p><p className="text-xl font-medium text-white font-sans">{formatMoney(mj.reduce((a,c)=>a+(c.isWin?c.amount:-c.amount),0))}</p></div>
                    </div>
                );
            }
        };

        const DailyForm = ({ onAdd, categories }) => {
            const [data, setData] = useState({ date: getTodayString(), type: 'expense', sub: '餐飲', amt: '', note: '' });
            const cats = data.type === 'expense' ? categories.expense : categories.income;
            
            useEffect(() => {
                if (!cats.includes(data.sub)) {
                    setData(prev => ({...prev, sub: cats[0] || ''}));
                }
            }, [data.type, cats]);

            const submit = () => {
                if(!data.amt || data.amt<=0) return alert("金額錯誤");
                onAdd({ category: 'daily', date: data.date, type: data.type, subCategory: data.sub, amount: Number(data.amt), note: data.note });
                setData({...data, amt: '', note: ''});
            };
            return (
                <div className="space-y-6">
                    <div className="flex border-b border-gray-100 pb-4">
                        <button onClick={()=>setData({...data, type:'expense'})} className={`flex-1 pb-2 text-sm tracking-widest transition border-b-2 ${data.type==='expense' ? 'border-muji-green text-muji-green font-bold' : 'border-transparent text-gray-400'}`}>支出</button>
                        <button onClick={()=>setData({...data, type:'income'})} className={`flex-1 pb-2 text-sm tracking-widest transition border-b-2 ${data.type==='income' ? 'border-muji-red text-muji-red font-bold' : 'border-transparent text-gray-400'}`}>收入</button>
                    </div>
                    <div className="flex items-center justify-between"><input type="date" value={data.date} onChange={e=>setData({...data, date:e.target.value})} className="bg-transparent font-sans text-muji-text text-sm outline-none"/></div>
                    <div className="flex flex-wrap gap-2">
                        {cats.length > 0 ? cats.map(c => (<button key={c} onClick={()=>setData({...data, sub:c})} className={`px-4 py-2 text-xs rounded-lg transition-all ${data.sub===c ? 'bg-muji-ink text-white' : 'bg-gray-100 text-gray-500'}`}>{c}</button>)) : <span className="text-xs text-gray-400">請至設定新增類別</span>}
                    </div>
                    <div className="relative border-b border-gray-200"><span className="absolute left-0 top-1/2 -translate-y-1/2 text-xl font-sans text-gray-300">$</span><input type="number" placeholder="0" value={data.amt} onChange={e=>setData({...data, amt:e.target.value})} className="w-full pl-6 py-2 text-4xl font-sans font-bold text-right outline-none bg-transparent text-muji-text"/></div>
                    <input placeholder="備註..." value={data.note} onChange={e=>setData({...data, note:e.target.value})} className="w-full bg-gray-50 p-3 rounded-lg text-sm outline-none text-muji-text placeholder-gray-400"/>
                    <button onClick={submit} className="w-full py-4 bg-muji-ink text-white rounded-xl shadow-lg hover:opacity-90 transition tracking-widest uppercase text-xs">儲存紀錄</button>
                </div>
            );
        };

        const TeaForm = ({ onAdd, records }) => {
            const [data, setData] = useState({ date: getTodayString(), shop: '', item: '', sugar: '半糖', ice: '少冰', amt: '' });
            const shops = [...new Set(records.filter(r=>r.category==='tea').map(r=>r.shop))];
            const items = [...new Set(records.filter(r=>r.category==='tea' && r.shop===data.shop).map(r=>r.item))];
            const submit = () => {
                if(!data.amt || !data.shop) return alert("資料不全");
                onAdd({ category: 'tea', ...data, amount: Number(data.amt) });
                setData({...data, amt: '', shop: '', item: ''});
            };
            return (
                <div className="space-y-5">
                    <input type="date" value={data.date} onChange={e=>setData({...data, date:e.target.value})} className="bg-transparent font-sans text-muji-text text-sm outline-none"/>
                    <div className="grid grid-cols-2 gap-4">
                        <div className="space-y-1"><label className="text-[10px] text-gray-400 uppercase">店家</label><input list="shops" value={data.shop} onChange={e=>setData({...data, shop:e.target.value})} className="w-full border-b border-gray-200 py-2 outline-none text-sm text-muji-text" placeholder="店家"/><datalist id="shops">{shops.map(s=><option key={s} value={s}/>)}</datalist></div>
                        <div className="space-y-1"><label className="text-[10px] text-gray-400 uppercase">品項</label><input list="items" value={data.item} onChange={e=>setData({...data, item:e.target.value})} className="w-full border-b border-gray-200 py-2 outline-none text-sm text-muji-text" placeholder="品項"/><datalist id="items">{items.map(i=><option key={i} value={i}/>)}</datalist></div>
                    </div>
                    <div className="flex gap-2 overflow-x-auto pb-2">{['無糖','微糖','半糖','少糖','全糖'].map(s=><button key={s} onClick={()=>setData({...data, sugar:s})} className={`px-3 py-1 text-xs rounded-full border ${data.sugar===s?'border-muji-ink text-muji-ink bg-gray-100':'border-gray-200 text-gray-400'}`}>{s}</button>)}</div>
                    <div className="flex gap-2 overflow-x-auto pb-2">{['熱','去冰','微冰','少冰','正常'].map(i=><button key={i} onClick={()=>setData({...data, ice:i})} className={`px-3 py-1 text-xs rounded-full border ${data.ice===i?'border-muji-ink text-muji-ink bg-gray-100':'border-gray-200 text-gray-400'}`}>{i}</button>)}</div>
                    <div className="relative border-b border-gray-200"><span className="absolute left-0 top-1/2 -translate-y-1/2 text-xl font-sans text-gray-300">$</span><input type="number" placeholder="0" value={data.amt} onChange={e=>setData({...data, amt:e.target.value})} className="w-full pl-6 py-2 text-4xl font-sans font-bold text-right outline-none bg-transparent text-muji-text"/></div>
                    <button onClick={submit} className="w-full py-4 bg-muji-ink text-white rounded-xl shadow-lg hover:opacity-90 transition tracking-widest uppercase text-xs">儲存飲料</button>
                </div>
            );
        };

        const MahjongForm = ({ onAdd, records }) => {
            const [data, setData] = useState({ date: getTodayString(), players: [], win: true, amt: '', newP: '' });
            const allP = useMemo(() => {
                const s = new Set(records.filter(r=>r.category==='mahjong').flatMap(r=>r.players)); ['阿明','小華','美美'].forEach(x=>s.add(x)); if(data.newP) s.add(data.newP); return [...s];
            }, [records, data.newP]);
            const toggle = (p) => { if(data.players.includes(p)) setData({...data, players: data.players.filter(x=>x!==p)}); else if(data.players.length < 3) setData({...data, players: [...data.players, p]}); };
            const submit = () => { if(data.players.length !== 3 || !data.amt) return alert("資料錯誤"); onAdd({ category: 'mahjong', date: data.date, players: data.players, isWin: data.win, amount: Number(data.amt) }); setData({...data, amt: '', players: []}); };
            return (
                <div className="space-y-6">
                    <div className="flex bg-gray-100 p-1 rounded-lg">
                        <button onClick={()=>setData({...data, win:true})} className={`flex-1 py-2 text-xs rounded-md transition ${data.win?'bg-white shadow text-muji-red font-bold':'text-gray-400'}`}>贏 (紅)</button>
                        <button onClick={()=>setData({...data, win:false})} className={`flex-1 py-2 text-xs rounded-md transition ${!data.win?'bg-white shadow text-muji-green font-bold':'text-gray-400'}`}>輸 (綠)</button>
                    </div>
                    <div>
                        <div className="flex justify-between items-center mb-2"><span className="text-xs uppercase text-gray-400">選擇麻友 ({data.players.length}/3)</span><div className="flex items-center border-b border-gray-200"><input placeholder="輸入名字" value={data.newP} onChange={e=>setData({...data, newP:e.target.value})} className="text-xs w-20 py-1 outline-none bg-transparent text-muji-text"/><Icons.Plus size={12} className="text-gray-400"/></div></div>
                        <div className="flex flex-wrap gap-2">{allP.map(p => (<button key={p} onClick={()=>toggle(p)} className={`px-3 py-1 text-xs rounded-full border transition ${data.players.includes(p)?'bg-muji-ink text-white border-muji-ink':'bg-white text-gray-500 border-gray-200'}`}>{p}</button>))}</div>
                    </div>
                    <div className="relative border-b border-gray-200"><span className={`absolute left-0 top-1/2 -translate-y-1/2 text-xl font-sans ${data.win?'text-muji-red':'text-muji-green'}`}>$</span><input type="number" placeholder="0" value={data.amt} onChange={e=>setData({...data, amt:e.target.value})} className={`w-full pl-6 py-2 text-4xl font-sans font-bold text-right outline-none bg-transparent ${data.win?'text-muji-red':'text-muji-green'}`}/></div>
                    <button onClick={submit} className="w-full py-4 bg-muji-ink text-white rounded-xl shadow-lg hover:opacity-90 transition tracking-widest uppercase text-xs">儲存戰績</button>
                </div>
            );
        };

        const CalendarView = ({ records, onDelete, category }) => {
            const [viewDate, setViewDate] = useState(new Date());
            const [selDate, setSelDate] = useState(getTodayString());
            const [showPicker, setShowPicker] = useState(false);
            const filteredRecords = useMemo(() => {
                return records.filter(r => r.category === category);
            }, [records, category]);
            const getDayInfo = (d) => {
                const dateStr = `${viewDate.getFullYear()}-${String(viewDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const rs = filteredRecords.filter(r=>r.date===dateStr);
                const hasData = rs.length > 0;
                const total = rs.reduce((a,c) => { 
                    if (c.type === 'income' || c.isWin) return a + Number(c.amount); 
                    if (c.type === 'expense' || (c.category === 'mahjong' && !c.isWin) || c.category === 'tea') return a - Number(c.amount); 
                    return a; 
                }, 0);
                return { dateStr, hasData, total };
            };
            const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
            const startDay = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();
            const offset = startDay === 0 ? 6 : startDay - 1;
            const selRecords = filteredRecords.filter(r=>r.date===selDate);
            const jumpToToday = () => { const now = new Date(); setViewDate(now); setSelDate(getTodayString()); setShowPicker(false); };
            const changeMonth = (m) => { const newDate = new Date(viewDate.getFullYear(), m, 1); setViewDate(newDate); setShowPicker(false); };
            const changeYear = (y) => { const newDate = new Date(y, viewDate.getMonth(), 1); setViewDate(newDate); };

            return (
                <div className="px-6 animate-fade-in mb-6 relative">
                    {showPicker && (
                        <div className="absolute top-16 left-6 right-6 bg-white p-4 shadow-xl rounded-2xl z-20 border border-gray-100 animate-fade-in">
                            <div className="flex justify-between items-center mb-4 px-2">
                                <button onClick={() => changeYear(viewDate.getFullYear() - 1)} className="p-2 hover:bg-gray-100 rounded-full text-muji-ink"><Icons.ChevronLeft size={20}/></button>
                                <span className="font-bold text-xl text-muji-ink font-sans">{viewDate.getFullYear()}</span>
                                <button onClick={() => changeYear(viewDate.getFullYear() + 1)} className="p-2 hover:bg-gray-100 rounded-full text-muji-ink"><Icons.ChevronRight size={20}/></button>
                            </div>
                            <div className="grid grid-cols-4 gap-2">{Array.from({length: 12}).map((_, i) => (<button key={i} onClick={() => changeMonth(i)} className={`p-2 rounded-lg text-sm font-sans font-medium transition-colors ${viewDate.getMonth() === i ? 'bg-muji-ink text-white' : 'hover:bg-gray-50 text-gray-600'}`}>{i + 1}月</button>))}</div>
                        </div>
                    )}
                    <div className="bg-muji-white p-4 rounded-3xl shadow-card border border-muji-border relative z-10">
                        <div className="flex justify-between items-center mb-4 px-2">
                            <div className="w-8"></div>
                            <button onClick={() => setShowPicker(!showPicker)} className="flex items-center gap-2 px-3 py-1 rounded-lg hover:bg-gray-50 transition-colors">
                                <h2 className="text-xl font-bold font-sans text-muji-ink tracking-widest">{viewDate.getFullYear()} . {String(viewDate.getMonth()+1).padStart(2,'0')}</h2>
                                <Icons.ChevronDown size={16} className={`text-muji-ink transition-transform duration-300 ${showPicker ? 'rotate-180' : ''}`} />
                            </button>
                            <button onClick={jumpToToday} className="w-8 h-8 flex items-center justify-center rounded-full bg-muji-paper text-muji-ink hover:bg-muji-ink hover:text-white transition-colors" title="回到今天"><Icons.Target size={18} /></button>
                        </div>
                        <div className="grid grid-cols-7 text-center mb-2">{['一','二','三','四','五','六','日'].map((d,i)=><div key={d} className={`text-[10px] uppercase tracking-wider ${i>=5?'text-muji-red opacity-60':'text-gray-300'}`}>{d}</div>)}</div>
                        <div className="grid grid-cols-7 gap-1">
                            {Array.from({length: offset}).map((_,i)=><div key={`empty-${i}`}/>)}
                            {Array.from({length: daysInMonth}).map((_,i)=> {
                                const day = i+1; const info = getDayInfo(day); const isSel = info.dateStr === selDate;
                                return (
                                    <div key={day} onClick={()=>setSelDate(info.dateStr)} className={`flex flex-col items-center justify-start pt-1 cursor-pointer h-12 w-full mx-auto rounded-lg relative border transition-all duration-200 ${isSel ? 'border-muji-ink bg-muji-ink/5' : 'border-transparent hover:border-gray-100'}`}>
                                        <span className={`relative z-10 text-[10px] font-medium leading-none ${isSel?'text-muji-ink font-bold':'text-gray-400'}`}>{day}</span>
                                        {info.hasData && (<span className={`relative z-10 text-[10px] font-bold mt-1 tracking-tight ${info.total >= 0 ? 'text-muji-red' : 'text-muji-green'}`}>{info.total === 0 ? '-' : Math.abs(info.total)}</span>)}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    <div className="mt-6 space-y-3">
                        <h3 className="text-xs text-gray-400 uppercase tracking-widest pl-2 mb-2 font-sans">{selDate} • {category==='daily'?'日常':category==='tea'?'手搖':'麻將'}</h3>
                        {selRecords.length === 0 && <div className="text-center py-8 text-gray-300 text-sm italic">本日無紀錄</div>}
                        {selRecords.map(r => (
                            <div key={r.id} className="bg-white p-4 rounded-xl shadow-sm flex items-center justify-between animate-slide-up border border-transparent hover:border-gray-200 group">
                                <div className="flex items-center gap-4">
                                    <div className={`w-1 h-10 rounded-full ${r.category==='tea'?'bg-muji-kraft':(r.type==='income'||r.isWin?'bg-muji-red':'bg-muji-green')}`}></div>
                                    <div><p className="font-medium text-muji-text text-sm">{r.category==='daily'?r.subCategory:r.category==='tea'?r.shop:'麻將'}</p><p className="text-xs text-gray-400">{r.category==='tea'?`${r.item} ${r.sugar}`:r.category==='mahjong'?(r.isWin?'贏':'輸'):r.note}</p></div>
                                </div>
                                <div className="text-right">
                                    <p className={`font-sans font-medium ${r.type==='expense'||!r.isWin||r.category==='tea'?'text-muji-green':'text-muji-red'}`}>{formatMoney(r.amount)}</p>
                                    <button onClick={()=>onDelete(r.id)} className="opacity-0 group-hover:opacity-100 transition text-gray-300 hover:text-red-400"><Icons.Trash size={14}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const StatsView = ({ records, category, categories }) => {
            const chartData = useMemo(() => {
                if(category!=='daily') return [];
                const exps = records.filter(r=>r.category==='daily' && r.type==='expense');
                const grp = exps.reduce((a,c) => { a[c.subCategory]=(a[c.subCategory]||0)+Number(c.amount); return a; }, {});
                return Object.keys(grp).map(k=>({name:k, value:grp[k]}));
            }, [records, category]);
            const COLORS = ['#748E78', '#C85A5A', '#D3C4A5', '#BBADA2', '#999999'];
            const teaStats = useMemo(() => {
                if(category!=='tea') return null;
                const ts = records.filter(r=>r.category==='tea');
                if(!ts.length) return { shop:'-', item:'-', cups:0 };
                const sc={}, ic={}; ts.forEach(t => { sc[t.shop]=(sc[t.shop]||0)+1; ic[t.item]=(ic[t.item]||0)+1; });
                return { shop: Object.keys(sc).reduce((a,b)=>sc[a]>sc[b]?a:b), item: Object.keys(ic).reduce((a,b)=>ic[a]>ic[b]?a:b), cups: ts.length };
            }, [records, category]);

            return (
                <div className="px-6 animate-fade-in mb-6">
                    {category === 'daily' && (
                        <div className="bg-muji-white p-6 rounded-3xl shadow-card border border-muji-border">
                            <h3 className="text-center text-sm tracking-widest uppercase mb-4 text-gray-400">支出類別分析</h3>
                            {chartData.length > 0 ? (
                                <div className="h-64">
                                    <ResponsiveContainer><PieChart><Pie data={chartData} innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">{chartData.map((e,i)=><Cell key={i} fill={COLORS[i%COLORS.length]}/>)}</Pie><Tooltip formatter={(v)=>formatMoney(v)}/><Legend/></PieChart></ResponsiveContainer>
                                </div>
                            ) : <div className="text-center py-10 text-gray-300">無數據</div>}
                        </div>
                    )}
                    {category === 'tea' && (
                        <div className="space-y-4">
                            <StatBox label="最常去" val={teaStats ? teaStats.shop : '-'} icon={<Icons.Coffee size={20}/>} />
                            <StatBox label="必點" val={teaStats ? teaStats.item : '-'} icon={<Icons.Star size={20}/>} />
                            <StatBox label="總杯數" val={teaStats ? teaStats.cups : 0} icon={<Icons.Coins size={20}/>} />
                        </div>
                    )}
                    {category === 'mahjong' && (
                        <div className="bg-muji-ink text-white p-8 rounded-3xl shadow-float text-center">
                            <h3 className="text-sm tracking-widest uppercase opacity-80 mb-6">年度戰績總覽</h3>
                             <div className="flex justify-between items-end">
                                 <div><p className="text-3xl font-bold font-sans text-white/90">{records.filter(r=>r.category==='mahjong'&&r.isWin).length}</p><p className="text-[10px] uppercase mt-1">勝場</p></div>
                                 <div><p className="text-3xl font-bold font-sans text-white/90">{records.filter(r=>r.category==='mahjong'&&!r.isWin).length}</p><p className="text-[10px] uppercase mt-1">敗場</p></div>
                             </div>
                        </div>
                    )}
                </div>
            );
        };

        const StatBox = ({ label, val, icon }) => (
            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                <div><p className="text-[10px] uppercase tracking-widest text-gray-400">{label}</p><p className="text-xl font-medium mt-1 text-muji-text font-sans">{val}</p></div>
                <div className="text-gray-300">{icon}</div>
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TINA JOURNAL</title>
    <!-- 資源庫載入 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --muji-bg: #F2EFE9;
            --muji-card: #FFFFFF;
            --muji-text: #333333;
            --muji-accent: #7F7161;
            --muji-red: #B3544B;
            --muji-green: #6B7A5F;
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--muji-bg);
            color: var(--muji-text);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        [v-cloak] { display: none; }
        #app-error { display: none; padding: 40px; text-align: center; color: #888; font-size: 14px; }
        
        .muji-header { background-color: var(--muji-bg); z-index: 50; }
        .logo-font { font-family: 'Montserrat', sans-serif; letter-spacing: 0.2em; }
        
        /* 底線欄位樣式 */
        .muji-input-underline {
            background-color: transparent; border: none; border-bottom: 1px solid #EBE7E0;
            border-radius: 0; padding: 0.75rem 0.25rem; width: 100%; font-size: 16px;
        }
        .muji-input-underline:focus { outline: none; border-bottom-color: var(--muji-accent); }
        
        .muji-card { background-color: var(--muji-card); border-radius: 1.5rem; border: 1px solid rgba(230, 224, 217, 0.4); box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .muji-btn-confirm { background-color: var(--muji-accent); color: white; border-radius: 999px; padding: 1rem; width: 100%; font-weight: 500; letter-spacing: 0.2em; transition: opacity 0.2s; }
        .muji-btn-confirm:active { opacity: 0.8; }
        
        .modal-overlay { background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(2px); z-index: 100; }
        
        /* 月曆格子設計 */
        .calendar-cell { aspect-ratio: 1 / 1.5; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 10px; border-radius: 12px; font-size: 12px; position: relative; }
        .weekend-day { color: var(--muji-red) !important; }
        
        /* 分段按鈕 */
        .segmented-control { display: flex; background-color: rgba(230, 224, 217, 0.4); padding: 4px; border-radius: 14px; }
        .segmented-item { flex: 1; text-align: center; padding: 10px 0; font-size: 12px; font-weight: 600; border-radius: 10px; transition: all 0.2s; color: #A8A096; }
        .segmented-item.active { background-color: white; color: var(--muji-accent); box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        
        .cat-btn { padding: 0.6rem 1rem; border-radius: 999px; font-size: 12px; border: 1px solid #EBE7E0; background: white; color: #A8A096; transition: all 0.2s; }
        .cat-btn.active { background: var(--muji-accent); color: white; border-color: var(--muji-accent); }
        
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen flex flex-col overflow-x-hidden">

<div id="app-error">系統載入中...<br>若長時間沒反應，請嘗試在一般模式開啟。</div>

<div id="app" v-cloak>
    <!-- Header -->
    <header class="muji-header sticky top-0 px-6 py-8 flex justify-between items-center border-b border-stone-100">
        <div class="flex flex-col">
            <span class="text-xl font-bold logo-font text-[#333]">TINA JOURNAL</span>
        </div>
        <div class="flex items-center space-x-4">
            <div class="text-right">
                <p class="text-[9px] text-stone-300 leading-none mb-1 tracking-[0.2em] uppercase">Balance</p>
                <p class="text-sm font-bold text-stone-700">NT$ {{ formatNumber(annualTotal) }}</p>
            </div>
            <button @click="openSettings" class="text-stone-300 p-2">
                <i data-lucide="settings" class="w-6 h-6"></i>
            </button>
        </div>
    </header>

    <!-- Error Bar -->
    <div v-if="errorMsg" class="fixed top-28 left-0 right-0 z-[60] px-6">
        <div class="bg-red-50 text-red-500 text-[11px] py-3 px-4 rounded-xl border border-red-100 shadow-xl flex items-center animate-pulse">
            <i data-lucide="alert-circle" class="w-4 h-4 mr-2"></i> {{ errorMsg }}
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow px-5 pt-6 pb-36">
        
        <!-- Category Segmented Control -->
        <div class="segmented-control mb-10">
            <button v-for="cat in categories" @click="activeCategory = cat.id; errorMsg = ''; isEditing = false" :class="['segmented-item', activeCategory === cat.id ? 'active' : '']">
                {{ cat.name }}
            </button>
        </div>

        <!-- VIEW: ADD -->
        <div v-if="activeTab === 'add'" class="space-y-6">
            <div class="muji-card p-6 space-y-10 shadow-sm">
                <!-- 1. 日常 -->
                <div v-if="activeCategory === 'daily'" class="space-y-8">
                    <div class="segmented-control">
                        <button @click="forms.daily.type = 'exp'; forms.daily.category = dailyCats.exp[0]" :class="['segmented-item', forms.daily.type === 'exp' ? 'active !text-[#6B7A5F]' : '']">支出</button>
                        <button @click="forms.daily.type = 'inc'; forms.daily.category = dailyCats.inc[0]" :class="['segmented-item', forms.daily.type === 'inc' ? 'active !text-[#B3544B]' : '']">收入</button>
                    </div>
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[10px] text-stone-300 font-bold uppercase">Date</label><input type="date" v-model="forms.daily.date" class="muji-input-underline"></div>
                            <div class="flex flex-col">
                                <label class="text-[10px] text-stone-300 font-bold uppercase mb-2">Category</label>
                                <div class="flex flex-wrap gap-2">
                                    <button v-for="c in (forms.daily.type === 'exp' ? dailyCats.exp : dailyCats.inc)" @click="forms.daily.category = c" :class="['cat-btn', forms.daily.category === c ? 'active' : '']">{{ c }}</button>
                                </div>
                            </div>
                        </div>
                        <div><label class="text-[10px] text-stone-300 font-bold uppercase">Amount</label><input type="number" inputmode="decimal" v-model="forms.daily.amount" class="muji-input-underline font-bold text-2xl" placeholder="0"></div>
                        <div><label class="text-[10px] text-stone-300 font-bold uppercase">Note</label><input type="text" v-model="forms.daily.note" class="muji-input-underline" placeholder="去哪啦"></div>
                    </div>
                    <button @click="saveDaily" class="muji-btn-confirm">確認</button>
                </div>

                <!-- 2. 飲料 -->
                <div v-if="activeCategory === 'drinks'" class="space-y-8">
                    <div class="grid grid-cols-2 gap-6 items-end">
                        <div><label class="text-[10px] text-stone-300 font-bold uppercase">Date</label><input type="date" v-model="forms.drinks.date" class="muji-input-underline"></div>
                        <div class="pb-1">
                            <label class="text-[10px] text-stone-300 font-bold block mb-3 uppercase">Rating ({{ forms.drinks.rating }})</label>
                            <div class="flex space-x-1">
                                <template v-for="i in 5">
                                    <div class="relative cursor-pointer w-6 h-6 flex items-center justify-center">
                                        <i data-lucide="star" :class="['w-6 h-6', forms.drinks.rating >= i ? 'text-amber-400 fill-amber-400' : 'text-stone-100']"></i>
                                        <div class="absolute inset-y-0 left-0 w-1/2 h-full z-10" @click="setStarRating(i - 0.5)"></div>
                                        <div class="absolute inset-y-0 right-0 w-1/2 h-full z-10" @click="setStarRating(i)"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div><label class="text-[10px] text-stone-300 font-bold uppercase">Store</label><input list="stores" v-model="forms.drinks.store" class="muji-input-underline" placeholder="店名"><datalist id="stores"><option v-for="s in history.stores" :value="s"></option></datalist></div>
                        <div><label class="text-[10px] text-stone-300 font-bold uppercase">Item</label><input list="items" v-model="forms.drinks.item" class="muji-input-underline" placeholder="品項"><datalist id="items"><option v-for="it in history.items" :value="it"></option></datalist></div>
                    </div>
                    <div class="space-y-5">
                        <div class="space-y-2"><label class="text-[10px] text-stone-300 font-bold uppercase">Sugar</label><div class="segmented-control"><button v-for="s in ['無糖', '少糖', '半糖', '正常']" @click="forms.drinks.sugar = s" :class="['segmented-item', forms.drinks.sugar === s ? 'active' : '']">{{ s }}</button></div></div>
                        <div class="space-y-2"><label class="text-[10px] text-stone-300 font-bold uppercase">Ice</label><div class="segmented-control"><button v-for="i in ['去冰', '少冰', '正常', '熱']" @click="forms.drinks.ice = i" :class="['segmented-item', forms.drinks.ice === i ? 'active' : '']">{{ i }}</button></div></div>
                    </div>
                    <div><label class="text-[10px] text-stone-300 font-bold uppercase">Amount</label><input type="number" inputmode="decimal" v-model="forms.drinks.amount" class="muji-input-underline font-bold text-lg" placeholder="0"></div>
                    <button @click="saveDrink" class="muji-btn-confirm">確認</button>
                </div>

                <!-- 3. 麻將 -->
                <div v-if="activeCategory === 'mahjong'" class="space-y-8">
                    <div><label class="text-[10px] text-stone-300 font-bold uppercase">Date</label><input type="date" v-model="forms.mahjong.date" class="muji-input-underline"></div>
                    <div class="space-y-4">
                        <label class="text-[10px] text-stone-300 font-bold uppercase">Friends (Choose 3)</label>
                        <div class="flex flex-wrap gap-3">
                            <button v-for="f in history.friends" @click="toggleFriend(f)" :class="['px-5 py-2.5 text-xs rounded-full border transition-all', forms.mahjong.friends.includes(f) ? 'bg-[#7F7161] text-white border-[#7F7161]' : 'bg-white text-stone-300 border-stone-100']">{{ f }}</button>
                        </div>
                    </div>
                    <div class="segmented-control">
                        <button @click="forms.mahjong.type = 'win'" :class="['segmented-item', forms.mahjong.type === 'win' ? 'active !text-[#B3544B]' : '']">贏錢</button>
                        <button @click="forms.mahjong.type = 'loss'" :class="['segmented-item', forms.mahjong.type === 'loss' ? 'active !text-[#6B7A5F]' : '']">輸錢</button>
                    </div>
                    <div><label class="text-[10px] text-stone-300 font-bold uppercase text-center block">Result</label><input type="number" inputmode="decimal" v-model="forms.mahjong.amount" class="muji-input-underline text-3xl font-bold text-center" placeholder="0"></div>
                    <button @click="saveMahjong" class="muji-btn-confirm">確認</button>
                </div>
            </div>
        </div>

        <!-- VIEW: CALENDAR -->
        <div v-if="activeTab === 'calendar'" class="space-y-6">
            <div class="muji-card p-6 shadow-sm border-stone-100 flex flex-col space-y-6">
                <div class="flex justify-between items-center px-2">
                    <div class="flex items-center space-x-2">
                        <select v-model="calendarYear" class="text-base font-bold bg-stone-50 px-2 py-1 rounded-lg outline-none">
                            <option v-for="y in availableYears" :value="y">{{ y }}</option>
                        </select>
                        <span class="text-stone-200">/</span>
                        <select v-model="calendarMonth" class="text-base font-bold bg-stone-50 px-2 py-1 rounded-lg outline-none">
                            <option v-for="m in 12" :value="m-1">{{ String(m).padStart(2, '0') }}</option>
                        </select>
                    </div>
                    <button @click="goToday" class="w-10 h-10 rounded-full bg-stone-800 text-white text-[11px] flex items-center justify-center font-bold">今</button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-[10px] font-bold text-stone-300 tracking-[0.2em] uppercase border-b pb-4">
                    <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div class="weekend-day">Sat</div><div class="weekend-day">Sun</div>
                </div>
                <div class="grid grid-cols-7 gap-1.5">
                    <div v-for="day in calendarDays" :key="day.date" @click="selectDate(day)" :class="['calendar-cell border transition-all', day.isToday ? 'bg-stone-800 text-white shadow-lg z-10' : 'bg-stone-50/40 border-transparent', selectedDate === day.date && !day.isToday ? 'ring-2 ring-stone-200 bg-white shadow-sm' : '', !day.currentMonth ? 'opacity-0 pointer-events-none' : '']">
                        <span class="font-bold" :class="{'weekend-day': (day.dayOfWeek===6 || day.dayOfWeek===0) && !day.isToday}">{{ day.dayNum }}</span>
                        <div v-if="day.catTotal !== 0" class="text-[10px] font-black mt-2 truncate w-full text-center px-0.5" :class="day.catTotal > 0 ? (day.isToday ? 'text-red-300' : 'text-[#B3544B]') : (day.isToday ? 'text-green-200' : 'text-[#6B7A5F]')">
                            {{ day.catTotal > 0 ? '+' : '' }}{{ day.catTotal }}
                        </div>
                    </div>
                </div>
            </div>
            <div v-if="selectedDateRecords.length" class="space-y-3">
                <p class="px-3 text-[10px] text-stone-300 font-bold tracking-widest uppercase">{{ selectedDate }} ARCHIVE</p>
                <div v-for="rec in selectedDateRecords" :key="rec.id" class="muji-card p-5 flex justify-between items-center group active:bg-stone-50 transition-colors">
                    <div class="flex items-center space-x-4">
                        <div class="w-11 h-11 rounded-full bg-stone-50 flex items-center justify-center text-stone-300"><i :data-lucide="getIcon(rec.mode)" class="w-5 h-5"></i></div>
                        <div><p class="text-sm font-bold text-stone-700">{{ rec.category }} {{ rec.item || '' }}</p><p class="text-[11px] text-stone-400 font-medium">{{ rec.note || '去哪啦' }}</p></div>
                    </div>
                    <div class="text-right">
                        <p :class="['text-base font-bold', isPositive(rec) ? 'text-[#B3544B]' : 'text-[#6B7A5F]']">{{ isPositive(rec) ? '+' : '-' }}{{ formatNumber(rec.amount) }}</p>
                        <div class="flex space-x-4 mt-2 justify-end">
                            <button @click="copyRecord(rec)" class="text-[10px] text-stone-300 font-bold uppercase">Copy</button>
                            <button @click="editRecord(rec)" class="text-[10px] text-stone-400 font-bold uppercase">Edit</button>
                            <button @click="deleteRecord(rec.id)" class="text-[10px] text-red-200 font-bold uppercase">Del</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: DATA -->
        <div v-if="activeTab === 'data'" class="space-y-6">
            <h2 class="text-center text-[11px] text-stone-300 font-bold tracking-[0.5em] uppercase">{{ currentCategoryName }} ANALYSIS</h2>
            <!-- Data displays -->
            <div v-if="activeCategory === 'daily'" class="space-y-5">
                <div class="muji-card p-8">
                    <h3 class="text-xs font-bold mb-8 text-stone-600">Expenditure Ratio</h3>
                    <div class="space-y-6">
                        <div v-for="(val, cat) in dailyStatsByCategory" :key="cat">
                            <div class="flex justify-between text-[11px] mb-2 font-bold uppercase tracking-wider"><span>{{ cat }}</span><span>${{ formatNumber(val) }}</span></div>
                            <div class="w-full bg-stone-50 h-1 rounded-full overflow-hidden"><div class="bg-stone-400 h-1 rounded-full transition-all duration-1000" :style="{width: (val/stats.daily.totalExp * 100) + '%'}"></div></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- More data sections... -->
            <button @click="exportToExcel" class="w-full py-5 bg-white border border-stone-200 text-stone-300 text-[11px] rounded-full tracking-widest uppercase font-bold shadow-sm active:bg-stone-50">Export Spreadsheet</button>
        </div>
    </main>

    <!-- Success Modal -->
    <div v-if="showSuccess" class="fixed inset-0 modal-overlay flex items-center justify-center p-6">
        <div class="bg-white rounded-[3rem] p-12 text-center shadow-2xl w-full max-w-xs scale-in transform">
            <div class="w-16 h-16 bg-stone-800 text-white rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl"><i data-lucide="check" class="w-8 h-8"></i></div>
            <p class="font-bold tracking-[0.3em] text-stone-800 text-lg uppercase">新增成功！</p>
            <p class="text-[10px] text-stone-300 mt-4 font-bold uppercase tracking-tighter">Secured in Ledger</p>
        </div>
    </div>

    <!-- Settings -->
    <div v-if="showSettings" class="fixed inset-0 modal-overlay flex items-end" @click.self="showSettings = false">
        <div class="bg-white w-full rounded-t-[3.5rem] p-10 pb-16 space-y-8 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="w-12 h-1 bg-stone-100 rounded-full mx-auto -mt-4 mb-6"></div>
            <div v-if="settingsView === 'main'" class="space-y-5">
                <h3 class="text-center font-bold text-stone-700 tracking-widest text-sm uppercase mb-6">Archive Settings</h3>
                <div class="grid grid-cols-1 gap-3">
                    <button @click="settingsView = 'years'" class="flex justify-between items-center p-6 bg-stone-50/50 rounded-2xl"><span class="text-sm font-bold text-stone-600 uppercase tracking-widest">歷史帳本切換</span><i data-lucide="chevron-right" class="w-5 h-5 text-stone-200"></i></button>
                    <button @click="settingsView = 'cats'" class="flex justify-between items-center p-6 bg-stone-50/50 rounded-2xl"><span class="text-sm font-bold text-stone-600 uppercase tracking-widest">日常類別管理</span><i data-lucide="chevron-right" class="w-5 h-5 text-stone-200"></i></button>
                    <button @click="settingsView = 'friends'" class="flex justify-between items-center p-6 bg-stone-50/50 rounded-2xl"><span class="text-sm font-bold text-stone-600 uppercase tracking-widest">麻友管理</span><i data-lucide="chevron-right" class="w-5 h-5 text-stone-200"></i></button>
                </div>
                <div class="pt-12 border-t border-stone-50"><button @click="clearAllData" class="w-full py-5 text-[11px] text-red-300 tracking-widest uppercase font-bold">Wipe Data</button></div>
            </div>
            <!-- Sub-views for Settings (Years, Cats, Friends) go here -->
            <div v-if="settingsView === 'years'" class="space-y-6">
                <button @click="settingsView = 'main'" class="flex items-center text-[11px] font-bold text-stone-300 uppercase tracking-widest mb-4"><i data-lucide="chevron-left" class="w-4 h-4 mr-2"></i> Back</button>
                <div class="grid grid-cols-3 gap-4"><button v-for="y in availableYears" @click="currentYear = y; showSettings = false" :class="['py-4 text-xs font-bold rounded-2xl border transition', currentYear === y ? 'bg-stone-800 text-white border-stone-800 shadow-md' : 'bg-white text-stone-300 border-stone-100']">{{ y }}</button></div>
            </div>
            <div v-if="settingsView === 'cats'" class="space-y-6">
                <button @click="settingsView = 'main'" class="flex items-center text-[11px] font-bold text-stone-300 uppercase tracking-widest mb-4"><i data-lucide="chevron-left" class="w-4 h-4 mr-2"></i> Back</button>
                <div class="flex flex-wrap gap-3"><span v-for="c in dailyCats.exp" class="flex items-center px-5 py-3 bg-stone-50 text-[11px] font-bold text-stone-500 rounded-full border border-stone-100">{{ c }} <button @click="removeDailyCat(c)" class="ml-3 text-stone-200">×</button></span><button @click="addDailyCatPrompt" class="px-5 py-3 border border-dashed border-stone-200 text-stone-200 text-[11px] font-bold rounded-full">＋ New</button></div>
            </div>
            <div v-if="settingsView === 'friends'" class="space-y-6">
                <button @click="settingsView = 'main'" class="flex items-center text-[11px] font-bold text-stone-300 uppercase tracking-widest mb-4"><i data-lucide="chevron-left" class="w-4 h-4 mr-2"></i> Back</button>
                <div class="flex flex-wrap gap-3"><span v-for="f in history.friends" class="flex items-center px-5 py-3 bg-stone-50 text-[11px] font-bold text-stone-500 rounded-full border border-stone-100">{{ f }} <button @click="removeFriend(f)" class="ml-3 text-stone-200">×</button></span><button @click="addFriendPrompt" class="px-5 py-3 border border-dashed border-stone-200 text-stone-200 text-[11px] font-bold rounded-full">＋ Add</button></div>
            </div>
            <button @click="showSettings = false" class="w-full py-5 bg-stone-50 rounded-3xl text-[11px] font-bold text-stone-400 uppercase tracking-widest">Close Menu</button>
        </div>
    </div>

    <!-- Nav Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-xl border-t border-stone-100 px-20 py-8 flex justify-between items-center max-w-md mx-auto z-40 rounded-t-[4rem] shadow-2xl">
        <button @click="activeTab = 'calendar'; errorMsg = ''" :class="['flex flex-col items-center transition', activeTab === 'calendar' ? 'text-stone-800' : 'text-stone-200']"><i data-lucide="calendar" class="w-6 h-6"></i></button>
        <button @click="prepareAdd" class="w-16 h-16 bg-stone-800 rounded-full shadow-2xl flex items-center justify-center text-white -mt-20 border-[8px] border-[#F2EFE9] active:scale-90 transition"><i data-lucide="plus" class="w-8 h-8"></i></button>
        <button @click="activeTab = 'data'; errorMsg = ''" :class="['flex flex-col items-center transition', activeTab === 'data' ? 'text-stone-800' : 'text-stone-200']"><i data-lucide="pie-chart" class="w-6 h-6"></i></button>
    </nav>
</div>

<script>
window.onload = function() {
    try {
        const { createApp, ref, onMounted, computed, watch, nextTick } = Vue;

        const App = {
            setup() {
                const activeTab = ref('add');
                const activeCategory = ref('daily');
                const showSuccess = ref(false);
                const showSettings = ref(false);
                const settingsView = ref('main');
                const isEditing = ref(false);
                const editingId = ref(null);
                const currentYear = ref(new Date().getFullYear());
                const errorMsg = ref('');

                const getTodayStr = () => {
                    const d = new Date();
                    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                };

                const safeGet = (key, fallback) => {
                    try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch(e) { return fallback; }
                };

                const records = ref(safeGet('tina_journal_v5', []));
                const history = ref(safeGet('tina_hist_v5', {"stores":[], "items":[], "friends":["自己", "朋友A", "朋友B"]}));
                const dailyCats = ref(safeGet('tina_cats_v5', {
                    exp: ['餐飲', '交通', '購物', '娛樂', '醫療', '社交'],
                    inc: ['薪水', '獎金', '投資']
                }));

                const forms = ref({
                    daily: { date: getTodayStr(), type: 'exp', category: '餐飲', amount: '', note: '' },
                    drinks: { date: getTodayStr(), rating: 0, store: '', item: '', sugar: '無糖', ice: '去冰', amount: '' },
                    mahjong: { date: getTodayStr(), friends: [], type: 'win', amount: '' }
                });

                const categories = [ { id: 'daily', name: '日常' }, { id: 'drinks', name: '飲料' }, { id: 'mahjong', name: '麻將' } ];
                const calendarYear = ref(new Date().getFullYear());
                const calendarMonth = ref(new Date().getMonth());
                const selectedDate = ref(getTodayStr());

                const formatNumber = (num) => Number(num || 0).toLocaleString();
                const currentCategoryName = computed(() => categories.find(c => c.id === activeCategory.value).name);
                const isPositive = (rec) => ['inc', 'win'].includes(rec.type);
                const availableYears = computed(() => {
                    const y = new Set(records.value.map(r => new Date(r.date).getFullYear()));
                    y.add(new Date().getFullYear());
                    return Array.from(y).sort((a,b)=>b-a);
                });

                const refreshIcons = () => nextTick(() => { if(window.lucide) window.lucide.createIcons(); });

                const validate = (d) => {
                    errorMsg.value = '';
                    if(!d.amount || Number(d.amount) <= 0) { errorMsg.value = '金額必須大於 0 哦！'; return false; }
                    if(activeCategory.value==='daily' && !d.category) { errorMsg.value='類別忘記選了！'; return false; }
                    if(activeCategory.value==='drinks' && (!d.store || !d.item)) { errorMsg.value='店名與品項都要寫喔！'; return false; }
                    if(activeCategory.value==='mahjong' && d.friends.length !== 3) { errorMsg.value='麻將要選剛好 3 位朋友！'; return false; }
                    return true;
                };

                const commit = (data) => {
                    if(isEditing.value) {
                        records.value = records.value.map(r => r.id === editingId.value ? {...data, id: editingId.value} : r);
                        isEditing.value = false; editingId.value = null;
                    } else {
                        records.value.push({...data, id: Date.now()});
                    }
                    showSuccess.value = true;
                    setTimeout(()=> showSuccess.value = false, 1500);
                    refreshIcons();
                };

                const saveDaily = () => { if(validate(forms.value.daily)) { commit({...forms.value.daily, mode:'daily'}); forms.value.daily.amount=''; forms.value.daily.note=''; } };
                const saveDrink = () => { if(validate(forms.value.drinks)) {
                    commit({...forms.value.drinks, mode:'drinks', category:'飲料'});
                    if(!history.value.stores.includes(forms.value.drinks.store)) history.value.stores.push(forms.value.drinks.store);
                    if(!history.value.items.includes(forms.value.drinks.item)) history.value.items.push(forms.value.drinks.item);
                    forms.value.drinks.amount=''; forms.value.drinks.rating=0;
                }};
                const saveMahjong = () => { if(validate(forms.value.mahjong)) { commit({...forms.value.mahjong, mode:'mahjong', category:'麻將'}); forms.value.mahjong.amount=''; } };

                const deleteRecord = (id) => { if(confirm("確定刪除？")) records.value = records.value.filter(r => r.id !== id); };
                const copyRecord = (rec) => { activeTab.value = 'add'; activeCategory.value = rec.mode; const {id, ...rest} = rec; forms.value[rec.mode] = JSON.parse(JSON.stringify(rest)); isEditing.value = false; refreshIcons(); };
                const editRecord = (rec) => { activeTab.value = 'add'; activeCategory.value = rec.mode; forms.value[rec.mode] = JSON.parse(JSON.stringify(rec)); isEditing.value = true; editingId.value = rec.id; refreshIcons(); };
                const cancelEdit = () => { isEditing.value = false; editingId.value = null; resetForms(); };
                const prepareAdd = () => { activeTab.value = 'add'; isEditing.value = false; resetForms(); errorMsg.value = ''; refreshIcons(); };
                const resetForms = () => { const t = getTodayStr(); forms.value.daily.date = t; forms.value.drinks.date = t; forms.value.mahjong.date = t; };
                const goToday = () => { const n = new Date(); calendarYear.value = n.getFullYear(); calendarMonth.value = n.getMonth(); selectedDate.value = getTodayStr(); refreshIcons(); };
                const openSettings = () => { showSettings.value = true; settingsView.value = 'main'; refreshIcons(); };

                const annualTotal = computed(() => records.value.filter(r => new Date(r.date).getFullYear() === currentYear.value).reduce((s, r) => s + (isPositive(r) ? Number(r.amount) : -Number(r.amount)), 0));
                const stats = computed(() => {
                    const cur = records.value.filter(r => new Date(r.date).getFullYear() === calendarYear.value && new Date(r.date).getMonth() === calendarMonth.value);
                    return { daily: { totalExp: cur.filter(r => r.mode === 'daily' && r.type === 'exp').reduce((s, r) => s + Number(r.amount), 0) }, drinks: { totalCups: records.value.filter(r => r.mode === 'drinks' && new Date(r.date).getFullYear() === calendarYear.value).length } };
                });
                const dailyStatsByCategory = computed(() => {
                    const res = {};
                    records.value.filter(r => r.mode === 'daily' && r.type === 'exp' && new Date(r.date).getFullYear() === calendarYear.value && new Date(r.date).getMonth() === calendarMonth.value).forEach(r => res[r.category] = (res[r.category] || 0) + Number(r.amount));
                    return res;
                });
                const favoriteDrink = computed(() => {
                    const d = records.value.filter(r => r.mode === 'drinks' && new Date(r.date).getFullYear() === calendarYear.value);
                    if(!d.length) return {};
                    const count = (arr, k) => arr.reduce((a, r) => (a[r[k]] = (a[r[k]] || 0) + 1, a), {});
                    const fav = (obj) => Object.keys(obj).length ? Object.keys(obj).reduce((a,b) => obj[a] > obj[b] ? a : b) : '-';
                    return { store: fav(count(d, 'store')), item: fav(count(d, 'item')) };
                });

                const calendarDays = computed(() => {
                    const first = new Date(calendarYear.value, calendarMonth.value, 1);
                    const last = new Date(calendarYear.value, calendarMonth.value + 1, 0);
                    let days = [];
                    let start = first.getDay() || 7;
                    for (let i = 1; i < start; i++) days.push({ currentMonth: false });
                    for (let i = 1; i <= last.getDate(); i++) {
                        const dStr = calendarYear.value + '-' + String(calendarMonth.value + 1).padStart(2, '0') + '-' + String(i).padStart(2, '0');
                        const dayRecs = records.value.filter(r => r.date === dStr && r.mode === activeCategory.value);
                        const tot = dayRecs.reduce((a, r) => a + (isPositive(r) ? Number(r.amount) : -Number(r.amount)), 0);
                        days.push({ dayNum: i, currentMonth: true, date: dStr, catTotal: tot, isToday: dStr === getTodayStr(), dayOfWeek: new Date(dStr).getDay() });
                    }
                    return days;
                });
                const selectedDateRecords = computed(() => records.value.filter(r => r.date === selectedDate.value && r.mode === activeCategory.value));
                const selectDate = (d) => { if (d.date) selectedDate.value = d.date; refreshIcons(); };
                const getIcon = (m) => m === 'drinks' ? 'cup-soda' : (m === 'mahjong' ? 'clover' : 'edit-3');
                const getFriendWinRate = (f) => { const g = records.value.filter(r => r.mode === 'mahjong' && r.friends.includes(f)); return g.length ? Math.round((g.filter(r => r.type === 'win').length / g.length) * 100) : 0; };
                const setStarRating = (r) => { forms.value.drinks.rating = r; refreshIcons(); };
                const toggleFriend = (f) => { const i = forms.value.mahjong.friends.indexOf(f); i > -1 ? forms.value.mahjong.friends.splice(i, 1) : (forms.value.mahjong.friends.length < 3 && forms.value.mahjong.friends.push(f)); };
                const addFriendPrompt = () => { const n = prompt("輸入麻友姓名："); if(n) history.value.friends.push(n); };
                const removeFriend = (f) => history.value.friends = history.value.friends.filter(i => i !== f);
                const addDailyCatPrompt = () => { const n = prompt("輸入新分類名稱："); if(n) dailyCats.value.exp.push(n); };
                const removeDailyCat = (c) => dailyCats.value.exp = dailyCats.value.exp.filter(i => i !== c);
                const exportToExcel = () => { const ws = XLSX.utils.json_to_sheet(records.value); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "TINA"); XLSX.writeFile(wb, "TINA_JOURNAL.xlsx"); };
                const clearAllData = () => { if (confirm("確定抹除本地所有資料？")) { localStorage.clear(); location.reload(); } };

                watch([records, history, dailyCats, activeTab], () => {
                    try {
                        localStorage.setItem('tina_journal_v5', JSON.stringify(records.value));
                        localStorage.setItem('tina_hist_v5', JSON.stringify(history.value));
                        localStorage.setItem('tina_cats_v5', JSON.stringify(dailyCats.value));
                    } catch(e) {}
                    refreshIcons();
                }, { deep: true });

                onMounted(refreshIcons);

                return {
                    activeTab, activeCategory, categories, showSuccess, showSettings, settingsView, isEditing, currentYear, 
                    calendarYear, calendarMonth, availableYears, currentCategoryName, errorMsg,
                    records, history, dailyCats, forms, stats, annualTotal, dailyStatsByCategory, favoriteDrink,
                    calendarDays, selectedDate, selectedDateRecords,
                    formatNumber, isPositive, getIcon, saveDaily, saveDrink, saveMahjong, deleteRecord, copyRecord, editRecord, cancelEdit,
                    prepareAdd, goToday, selectDate, toggleFriend, addFriendPrompt, removeFriend, addDailyCatPrompt, removeDailyCat, 
                    exportToExcel, clearAllData, openSettings, getFriendWinRate, setStarRating
                };
            }
        };

        createApp(App).mount('#app');
    } catch (err) {
        document.getElementById('app-error').style.display = 'block';
        document.getElementById('app-error').innerText = '啟動失敗：' + err.message;
    }
};
</script>
</body>
</html>
